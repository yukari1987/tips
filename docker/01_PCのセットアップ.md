# Dockerを使用したWordPress環境構築
ver1.0 : ---.--.-- ren

このフォルダを使用することでXAMPPとは違い独立した環境でWordPress環境を立ち上げることができます。  
またdocker-compose.yml内のコメントアウトを適切に外すことでコピー環境を作成することも可能です。  
これらは使用するホストOSにDocker DescTop for windowsおよびdocker-composeが導入されていることを前提としています。  
導入できていない場合は「Dockerの導入」を参考にしてDockerをインストールしてください。  
## 構成
* apache
    * WordPress localhost:3000
        * DB_NAME: wordpress
        * DB_USER: root
    * php 7.2
        * xdebug 3.1.6
* phpmyadmin(最新のバージョン) localhost:4000
* mysql 5.7
    * root_password: ashica123
## Dockerの導入
DockerをWindowsで動かすためにはWSL2をインストールする必要があります。  
[https://chigusa-web.com/blog/wsl2-win11/]  
上記を参考にしてWSL2をインストールしてください。バージョンの指定は特にありません。  
次に下記を参考にしてDockerをインストールしてください。  
[https://chigusa-web.com/blog/windows%E3%81%ABdocker%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%97%E3%81%A6python%E7%92%B0%E5%A2%83%E3%82%92%E6%A7%8B%E7%AF%89/]  
[https://docs.docker.com/desktop/install/windows-install/]  
VirtualBoxがインストールされている場合は競合しうまく動かない場合があるため下記を参考にして設定を行ってください。  
[https://yu-nix.com/archives/wsl2-virtualbox-kyozon/]
- Linux 用 Windowsサブシステム
- Windows ハイパーバイザープラットフォーム
- 仮想マシン プラットフォーム
## WordPress環境の構築
新規にWordPress環境を構築した場合は以下の手順で作業します。
1. このフォルダーをコピーして適当な場所に配置します。
2. コマンドプロンプト、powershell、GitBashなど適当なターミナルソフトを立ち上げます。
3. $ cd でこのフォルダーまで移動します。
4. 次のコマンドを実行します。 $ docker-compose up -d
コマンドの詳しい説明は「Dockerコマンド」を参照してください。
## WordPress環境のコピー
WordPressの環境をコピーする場合は事前にSQLファイルとコピーしたい環境のwp-content以下のファイル群を用意してください。
1. SQLファイルのホストURLを「http://localhost:3000」と置き換えてください。
    1. vscodeの検索置き換え機能などを使用すると便利です。
    2. SQLファイルがうまく読み込めないとデータベースエラーが発生します。
2. SQLファイルをこのフォルダーのdb_entrypointフォルダー配下に設置してください。
    1. mysqlは通常仮想的な「mysql」というボリュームにマウントされています。
    2. 実際にファイルとして残しておきたい場合はdocker-compose.ymlの  
    「# - ./db:/var/lib/mysql」という部分のコメントアウトを外してください。
3. wp-content以下のファイル軍をwp/contentフォルダー配下に設置してください。
4. これ以降は「WordPress環境の構築」と同様です。
## xdebugの実行
xdebugを実行するためにはテキストエディターvscodeとそのプラグインPHP Debugが必要です。  
以下は導入されていることを前提として話を進めます。
1. このフォルダーをvscodeで開きます
    1. 必ずこのフォルダーだけを開いてください。
    2. 他のフォルダーを一緒に開いているとPHP Debugがうまく動かないことがあります。
2. vscodeの「実行とデバッグ」からデバッグを開始します。
3. コードの任意の位置にブレイクポイントを設置します。
4. phpを実行します。
詳細は以下のページを参考にしてください。  
[https://qiita.com/ryamate/items/74c57a290b78c812f089]  
[https://ichi-station.com/php-xdebug-vscode-docker/]
## Dockerコマンド
以下のコマンドは基本的にdocker-compose.ymlがあるディレクトリ内で使用してください。
### $ docker-compose up -d
docker-compose.ymlの情報を読み取りコンテナを作成します。  
-dをつけることでデタッチモードで起動しています。
### $ docker-compose stop
コンテナを停止します。
### $ docker-compose start
停止しているコンテナを起動します。
### $ docker-compose down
コンテナを削除します。  
**コンテナを起動中にdocker-compose.yml, dockerfileを編集するとdocker-compose downの際にエラーが出ます。**  
### $ docker-compose exec サービス名 コマンド
dockerコンテナにコマンドを渡します。  
例えばapacheサーバーにログインしたい際には以下のようになります。  
> $ docker-compose exec wordpress /bin/bash  

サービス名はdocker-compose.ymlで定義されています。  
**git bashでdocker-compose execを使用するときは文頭にwinptyをつける必要があります。**  
> $ winpty docker-compose exec wordpress /bin/bash
### $ docker-compose ps
起動中のコンテナの情報を表示します。  
その他の情報は以下を参考にしてください。  
[https://www.wakuwakubank.com/posts/354-docker-command-compose/]
# Dockerでプロジェクトを立ち上げる手順
ver1.0 : 2024.09.05  takasu
## なぜDockerを使うのか
お客様のサーバの環境（本番環境と言う）と同じものを、自身のPCに構築してから開発するためです。開発環境を本番環境に合わせることで、せっかく開発したのに本番環境にアップロードしたら動作しないなどのトラブルを防ぎます。
## 手順一覧
* PCの初期設定
* Dockerの立ち上げ
* Docker内でプロジェクトを編集するための初期設定
* プロジェクトを編集
* アップロード
* 最終確認

## PCの初期設定
1. まずDockerを使える環境を自身のPCにセットアップします。[./tips/01_PCのセットアップ.md](./tips/01_PCのセットアップ.md)を参考に構築してください。構築済の場合はこの手順は飛ばしてください。

#### セットアップ済かわからない時
  - WSLのインストールを確認：コマンドプロンプトで「wsl --version」と打ち、バージョンが表示されればインストール済
  - Dockerのインストールを確認：コマンドプロンプトで「docker version」と打ち、バージョンが表示されればインストール済

## Dockerの立ち上げ 
2. Dockerを立ち上げます。Dockerアイコンをクリックして画面が表示されればOKです。
1. Boxからプロジェクトの「プロジェクト名_local-project」を、フォルダごと自身のPCにダウンロードします。以降このコピーしたフォルダ内で作業します。
1. 最新の本番環境データ（tar.gz）を「wp_entrypoint」にセットするために、バックアップ済のファイルまたは本番環境上のデータをダウンロードします。基本的には本番環境上のデータを圧縮してダウンロードする方法が最新の状態を保てます。

   1. 【本番環境上のデータを圧縮しダウンロードする方法】
      * WinSCPからデータのあるサーバに接続します。
      * 該当のフォルダへ移動します。基本的には「public_html」直下です。
      * WinSCPの「コマンドで開く」を押し、「tar czfv フォルダ名.tar.gz *」と打ち込み、エンターを押します。このコマンドは該当フォルダ内の全てのデータをtar.gzファイルに圧縮します。
      * 圧縮できたらダウンロードし、「wp_entrypoint」に格納します。
      * サーバ上のtar.gzは不要となるため、削除してください。

   2. 【バックアップの圧縮データを利用する方法】
      *  HDDなどバックアップから該当プロジェクトを開き、「backup」→「最新の日付_all」→「プロジェクト名.tar.gz」を確認します。allはWordPress本体を含む全てのデータを保存しています。
      * ダウンロードした「プロジェクト名_local-project」→「wp_entrypoint」に、さきほどの「プロジェクト名.tar.gz」をダウンロードします。

5. 同様に「db_entrypoint」にも「プロジェクト名.sql」ファイルをセットします。サーバのMySQLにログインしてデータをエクスポートするか、バックアップからsqlをダウンロードしてください。
1. 「プロジェクト名_local-project」直下に戻り、画面の上にあるアドレスバーをクリックし、パスをコピーします。
1. Windowsの左下の検索画面から「コマンドプロンプト」と入力し、立ち上げます。
1. コマンドプロンプトで「cd 」(cdの後ろに半角スペース)と打ち、右クリックを押すと、さきほどコピーしたアドレスがペーストされるので、エンターキーを押します。これでPCにダウンロードしたプロジェクトフォルダに移動します。
1. 「docker compose up -d」と打ちます。
1. しばらく待つと、Docker上にプロジェクトのコンテナが立ち上がります。DockerのContainers画面でプロジェクト名が確認できれば成功です。

## Docker内でプロジェクトを編集するための初期設定
#### WordPressの設定
11. Chromeのシークレットモードで`http://localhost:4000`にアクセスします。
1. MySQLの画面が開くので、プロジェクトのデータベースをクリックし、「wp_options」のテーブルをクリックします。
1. 一番上の「siteurl」の「編集」をクリックします。
1. 「option_value」にホームページのアドレスが入っているので、`http://localhost:3000`に書き換え、右下の実行ボタンを押します。
1. テーブルの画面に戻るので、上から２つめの「home」も同様にアドレスを書き換えます。
#### VSCodeからDockerに接続
16. VSCodeを開き、左側の「リモートエクスプローラー」をクリックします。
1. プロジェクトの右に「wordpress」と表示されているところにカーソルを合わせ、「→」をクリックすると、画面が変わります。（ローカルPCからDockerのコンテナに接続が切り替わります。）
1. 左上の「ファイル」→「フォルダを開く」を押すと、上のバーにカーソルが移動するので、「var/www/html」と入力します。
1. プロジェクトのファイル群が表示されます。
1. SCSSを使う場合、VSCode左側の「拡張機能」から「Live Server」を検索し、インストールします。従来のVSCodeにインストールしていても、コンテナごとにインストールする必要があります。開発の時には右下の「Watch Sass」を押すことを忘れないでください。
#### 最終調整
21. `http://localhost:3000`にアクセスし、表示を確認します。
1. メニューをクリックしても他のページが表示されなかったら、`http://localhost:3000/wp-admin`(プロジェクトによりアドレスは違う可能性有)からWPにログインし、「設定」→「パーマリンク」→何も変更せず「変更を保存」を押すと、直ります。（.htaccessがリセットされます。）
1. 4でバックアップデータから起動している場合は、最新のthemeを確認します。Boxの「backup」＞「最新の日付_theme」があれば、そのテーマをダウンロードし、ログインしたWPの管理画面から、テーマを最新に切り替えます。
1. それでもエラーが表示される場合、`https://`にリダイレクトしている可能性があります。これは.htaccess内のコードで設定されているため、修正します。ファイルはプロジェクト直下と「wp-content」直下の２か所に設置されていることがあります。.htaccessファイルを探し、該当箇所をコメントアウトしてください。以下は例です
   ```
   # 以下がSSLリダイレクト設定されている例です。コメントアウトして、自身のPC環境下ではhttpにアクセスします。
   RewriteEngine On
   RewriteCond %{HTTPS} !on
   RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
   ```
1. .htaccessを修正したのにまだリダイレクトされる場合は、ブラウザのキャッシュが原因です。シークレットモードでもキャッシュが効いてしまうことがあるため、「Ctrl」+「Shift」+「Delete」を押すと、キャッシュクリア＆シークレットブラウザが閉じるので、再度シークレットモードを立ち上げてからアクセスしてください。

1. 上記の通り、うまくいかない場合はほとんどキャッシュ(ブラウザ側、コンテナ側の２種類)と.htaccess設定の問題です。慌てず、ひとつひとつ試してみてください。コンテナごとやり直したい場合は以下のコマンドを参考にしてください。
   ```
   # volume（コンテナ内のバックアップデータがある場所）ごとコンテナを消す
   docker compose down -v
   
   # imageのキャッシュを参照せず再度立ち上げる
    docker compose build --no-cache
    docker compose up -d
   ```

#### 初期設定が完了しました
ここまでの設定ができれば、以降は同じ手順を繰り返す必要はありません。

## プロジェクトの編集
#### コンテナ（Docker内のプロジェクトの環境）の起動を確認
Dockerの画面上で、「Containers」からプロジェクトのactionsを確認します。■になっていれば起動中です。PCを再起動した際は表示が▶になっているので、▶を押して起動してください。コンテナが起動していれば、http://localhost:3000に接続できます。
#### コンテナの起動が確認できたら、VSCodeで接続
1. VSCodeを開き、左側の「リモートエクスプローラー」をクリックします。
1. プロジェクトの右に「wordpress」と表示されているところにカーソルを合わせ、「→」をクリックすると、画面が変わります。（ローカルPCからDockerのコンテナに接続が切り替わります。）
1. 左上の「ファイル」→「フォルダを開く」を押すと、上のバーにカーソルが移動するので、「var/www/html」と入力します。
1. プロジェクトのファイル群が表示されます。
#### PCを終了する時は必ずDockerを停止してから
PCを終了させる前に、Dockerの画面で■を押しコンテナを停止して、さらにDocker画面を閉じることを忘れないでください。
#### コンテナ自体を消す時はバックアップがあるか確認してから
データはDockerのvolumeに「プロジェクト名_wordpress」等の名前で保存される設定を行っているので、コンテナを消しただけでは完全に消去はされませんが、開発が終わるごとに共有しやすい方法でバックアップを取ってください。
#### バックアップをとる方法
VSCodeから保存したいファイルおよびフォルダを右クリックし、「ダウンロード」を押します。保存したい場所を指定し、保存します。ほとんどの場合、開発しているテーマのフォルダのバックアップがあれば大丈夫です。修正のたびにWordPressの本体ごと保存してしまうと大容量になってしまうので、必要なバックアップは適宜精査してください。
#### バックアップを保管する場所
WordPress全体のバックアップをとるときは、wp-config.phpなどパスワードを含むファイルが存在することに留意し、保管場所には細心の注意を払ってください。例えばDropBoxやGoogleドライブは会社全体で利用しているため適切ではありません。Webチーム用のHDD、個人のPCをメインに管理してください。

## アップロード
#### themeのみアップロードする場合
1. 顧客サーバのWordPressのthemeフォルダに開発したテーマをアップロードします。
2. サーバのWordPressにログインし、アップロードしたthemeを設定します。

## 最終確認
#### HDDなどのバックアップを整理
自身のPCだけではなく、会社全体が管理している場所にバックアップデータを保存します。プロジェクトごとに「backup」フォルダがあるので、日付と内容を過去の例に倣って格納してください。
#### logを残す
logはHDDのほかにBoxにも残してください。
#### コンテナの整理
バックアップをとったら、頻繁に更新するような案件でなければコンテナと関連するimageを削除して、容量を空けることを意識してください。削除しても簡単に立ち上げることができるのがDockerを使うメリットのひとつです。
#### PCにダウンロードした開発用プロジェクトフォルダの整理
こちらもバックアップがあれば削除して大丈夫です。
#### Cドライブに空きがなくなった時
Docker内部のデータが肥大している可能性があります。[./tips/02_DockerでCドライブが逼迫した時の対処.md](./tips/02_DockerでCドライブが逼迫した時の対処.md)
#### 不便を感じたら改善の提案を
この手順書は完全ではありません。logをとる方法、書き方など、もっとこうした方がいいと思うことがあれば、ぜひご提案ください。